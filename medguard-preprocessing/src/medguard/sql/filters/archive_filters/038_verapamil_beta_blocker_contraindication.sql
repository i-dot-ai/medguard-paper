-- Filter 038: Verapamil + beta-blocker contraindication
--
-- This filter identifies patients who:
-- 1. Are prescribed verapamil (calcium channel blocker)
-- 2. Are also prescribed a beta-blocker
-- 3. The prescriptions overlap in time (concurrent use)
--
-- Clinical rationale:
-- Verapamil is a non-dihydropyridine calcium channel blocker with negative chronotropic
-- and inotropic effects. When combined with beta-blockers:
-- - Additive negative chronotropic effects → severe bradycardia, heart block
-- - Additive negative inotropic effects → heart failure, hypotension
-- - Risk of asystole, particularly in patients with pre-existing conduction abnormalities
-- - This is a well-established absolute/relative contraindication requiring careful monitoring
--
-- Design decisions:
-- - Include ALL verapamil formulations (tablets, modified-release, oral solutions)
-- - Include ALL beta-blockers: atenolol, bisoprolol, metoprolol, propranolol, carvedilol,
--   nebivolol, labetalol, sotalol
-- - Flag concurrent prescriptions (overlapping periods)
-- - Hazardous period = overlap between verapamil and beta-blocker
-- - Precision over recall: only flag clear overlaps

WITH verapamil_codes AS (
    -- IMPORTANT: This list includes UK SNOMED CT Extension codes (dm+d codes)
    -- UK dm+d codes are 13-15 digit codes containing '1000001'
    -- Verapamil - all formulations (tablets, modified-release, solutions)
    SELECT code FROM (VALUES
        -- Verapamil conventional release tablets (40mg, 80mg, 120mg, 160mg)
        ('42217311000001109'), ('42217111000001107'), ('42217411000001102'), ('42217211000001101'),
        ('820611000001102'), ('642311000001102'), ('783211000001104'), ('669211000001108'),
        ('1067011000001102'), ('969111000001101'), ('962411000001100'), ('1198211000001102'),
        ('1038611000001101'), ('1284711000001102'), ('1153011000001108'), ('1027111000001105'),
        ('1259111000001109'), ('982511000001103'),

        -- Verapamil modified-release tablets and capsules
        ('38750211000001107'), ('39021011000001106'), ('35367911000001103'), ('36149411000001103'),
        ('36565011000001105'), ('1086111000001102'), ('1094511000001104'), ('1101711000001102'),
        ('987811000001102'), ('1080011000001101'), ('10492611000001108'),

        -- Verapamil oral solutions and suspensions
        ('12940911000001104'), ('12941011000001107'), ('13014311000001101'), ('13014411000001108'),
        ('13014511000001107'), ('13014611000001106'), ('13014711000001102'), ('13014811000001105'),
        ('13014911000001100'), ('13015011000001100'), ('13015111000001104'), ('13015211000001105'),
        ('13015311000001102'), ('13015411000001109'), ('13015511000001108'), ('13015611000001107'),
        ('13015711000001103'), ('13015811000001106'), ('13015911000001101'), ('13016011000001109'),

        -- Verapamil tablets (various manufacturers)
        ('30111211000001102'), ('30111411000001103'), ('30111611000001100'), ('30111811000001101'),
        ('39918211000001109'), ('39919011000001109'), ('39918811000001105'), ('39918611000001106'),
        ('469111000001104'), ('390711000001102'), ('7911000001103'), ('797711000001100'),
        ('690411000001100'), ('409311000001103'), ('223411000001100'), ('232211000001107'),
        ('279811000001100'), ('454211000001101'), ('590011000001102'), ('15201811000001105'),
        ('15201611000001106'), ('21911311000001100'), ('21911511000001106'), ('36405511000001105'),
        ('36405711000001100'), ('36405911000001103'), ('37272411000001108'), ('37272211000001109'),
        ('40602711000001100'), ('569211000001103'), ('81311000001105'), ('156611000001107'),
        ('887611000001108'), ('90311000001104'), ('485611000001106'), ('596111000001103'),
        ('803411000001104'), ('40602911000001103'), ('40603411000001102'), ('4139411000001106'),
        ('25811000001105'), ('896311000001100'), ('534011000001101'), ('422111000001103'),
        ('1329811000001105'), ('1334011000001103'), ('1335111000001103'), ('1336311000001106'),
        ('12933411000001103'), ('12933711000001109'), ('12941211000001102')
    ) AS t(code)
),

beta_blocker_codes AS (
    -- IMPORTANT: Include UK dm+d codes for all beta-blockers
    -- Includes: atenolol, bisoprolol, metoprolol, propranolol, carvedilol,
    --           nebivolol, labetalol, sotalol
    SELECT code FROM (VALUES
        -- Atenolol (representative sample from 100 codes)
        ('42370411000001101'), ('42370611000001103'), ('42370711000001107'), ('41929211000001104'),
        ('41929011000001109'), ('41929811000001103'), ('45161611000001105'), ('282111000001106'),
        ('663211000001106'), ('884011000001109'), ('718711000001103'), ('393011000001109'),
        ('608911000001108'), ('1087111000001104'), ('1256211000001107'), ('1165211000001106'),
        ('5512311000001103'), ('5511711000001106'), ('5511911000001108'), ('5512411000001105'),
        ('12014311000001109'), ('12014411000001102'), ('12015011000001105'), ('12015211000001100'),
        ('12079011000001101'), ('12079111000001100'), ('12079211000001106'), ('12079311000001103'),
        ('22612411000001104'), ('22612211000001103'), ('22612611000001101'), ('35592111000001103'),
        ('35592311000001101'), ('38798311000001109'), ('38798111000001107'), ('38797711000001107'),
        ('39575411000001101'), ('39575211000001100'), ('39575611000001103'), ('41888411000001105'),
        ('41888211000001106'), ('41888011000001101'), ('18458411000001103'), ('18458811000001101'),
        ('18458611000001100'), ('42370511000001102'), ('12078711000001108'), ('12078811000001100'),

        -- Bisoprolol (representative sample from 100 codes)
        ('42371511000001109'), ('42371211000001106'), ('42371311000001103'), ('42371411000001105'),
        ('42371611000001108'), ('42371111000001100'), ('42621611000001100'), ('42621911000001106'),
        ('37231311000001108'), ('37231011000001105'), ('35138711000001101'), ('35138211000001108'),
        ('8305111000001102'), ('8305011000001103'), ('8304911000001103'), ('8304811000001108'),
        ('93911000001106'), ('634311000001108'), ('7376711000001106'), ('7376911000001108'),
        ('1135411000001101'), ('1121411000001102'), ('5461011000001103'), ('10285411000001102'),
        ('10285811000001100'), ('5452611000001106'), ('5460911000001106'), ('12287311000001105'),
        ('12287411000001103'), ('15160211000001100'), ('15160311000001108'), ('19734211000001100'),
        ('19734511000001102'), ('19708411000001100'), ('22621611000001102'), ('28365311000001102'),
        ('28365411000001109'), ('28365611000001107'), ('28365711000001103'), ('42622111000001103'),
        ('42622511000001107'), ('37230711000001104'), ('38809411000001105'), ('38809611000001108'),

        -- Metoprolol (representative sample from 100 codes)
        ('39992211000001108'), ('42377311000001109'), ('42377411000001102'), ('16632411000001109'),
        ('39835811000001103'), ('8668011000001102'), ('8668111000001101'), ('8668711000001100'),
        ('8668811000001108'), ('8668511000001105'), ('8668911000001103'), ('8668611000001109'),
        ('8669111000001108'), ('8669211000001102'), ('8669311000001105'), ('519211000001104'),
        ('573311000001103'), ('1015411000001101'), ('1085211000001102'), ('1152211000001109'),
        ('1296411000001101'), ('1089011000001109'), ('1280211000001101'), ('13006511000001103'),
        ('13006611000001104'), ('13006711000001108'), ('13006811000001100'), ('13006911000001105'),
        ('13007211000001104'), ('13007411000001100'), ('13007711000001106'), ('24383511000001105'),
        ('24383811000001108'), ('35167811000001103'), ('35168011000001105'), ('36035411000001108'),

        -- Propranolol (representative sample from 100 codes)
        ('42380211000001107'), ('42380511000001105'), ('42380311000001104'), ('42380111000001101'),
        ('41159611000001100'), ('41159211000001102'), ('42763811000001102'), ('42764111000001106'),
        ('38621711000001100'), ('38621311000001104'), ('38751111000001107'), ('38751211000001101'),
        ('41199611000001105'), ('41195511000001108'), ('45277111000001101'), ('45277411000001106'),
        ('45277711000001100'), ('8672811000001103'), ('8672911000001108'), ('8673011000001100'),
        ('1084611000001101'), ('940911000001104'), ('1210511000001100'), ('1100911000001107'),
        ('1243711000001109'), ('1284311000001101'), ('1122611000001105'), ('1162911000001105'),
        ('1054611000001107'), ('13160811000001109'), ('13160911000001104'), ('13161011000001107'),

        -- Carvedilol (representative sample from 100 codes)
        ('42372611000001102'), ('42372711000001106'), ('42372811000001103'), ('42372511000001101'),
        ('18518811000001104'), ('38934611000001105'), ('40208811000001107'), ('8356811000001107'),
        ('7377711000001109'), ('1080411000001105'), ('5542411000001101'), ('13202011000001101'),
        ('23958911000001109'), ('19711811000001107'), ('38823911000001107'), ('38933511000001108'),
        ('38934111000001102'), ('38934411000001107'), ('40288511000001108'), ('40288711000001103'),
        ('40209411000001102'), ('14012311000001106'), ('12422611000001106'), ('7332811000001101'),
        ('7377111000001108'), ('7377311000001105'), ('7377511000001104'), ('7398311000001102'),

        -- Nebivolol (representative sample from 100 codes)
        ('39701011000001101'), ('39701211000001106'), ('38659211000001107'), ('39701111000001100'),
        ('38003611000001107'), ('38003411000001109'), ('40959411000001108'), ('41217611000001103'),
        ('1254011000001107'), ('5502611000001106'), ('16561111000001106'), ('20312411000001102'),
        ('23644211000001108'), ('30063611000001108'), ('30063811000001107'), ('37726411000001100'),
        ('38003111000001104'), ('38639811000001107'), ('39051511000001104'), ('39050311000001100'),

        -- Labetalol (representative sample from 100 codes)
        ('42375811000001105'), ('42375711000001102'), ('42375911000001100'), ('42376011000001108'),
        ('8582311000001109'), ('8582411000001102'), ('8582111000001107'), ('8582211000001101'),
        ('8581911000001104'), ('8582011000001106'), ('311711000001109'), ('341511000001108'),
        ('929111000001109'), ('1160811000001101'), ('1301911000001109'), ('1311511000001104'),
        ('1038111000001109'), ('1240311000001104'), ('1271711000001109'), ('1237211000001105'),
        ('12643611000001102'), ('12643711000001106'), ('12643811000001103'), ('12643911000001108'),

        -- Sotalol (representative sample from 100 codes)
        ('42382611000001105'), ('42382511000001106'), ('42382411000001107'), ('42382711000001101'),
        ('8726611000001108'), ('8726711000001104'), ('8727411000001107'), ('8727111000001102'),
        ('8727511000001106'), ('8727211000001108'), ('8726811000001107'), ('8726911000001102'),
        ('646911000001102'), ('170011000001101'), ('1279711000001108'), ('1120211000001107'),
        ('1197911000001105'), ('1016511000001109'), ('948111000001100'), ('1075311000001100'),
        ('1054511000001108'), ('1283411000001105'), ('13323711000001105'), ('13323811000001102')
    ) AS t(code)
),

verapamil_prescriptions AS (
    SELECT DISTINCT
        FK_Patient_Link_ID,
        medication_start_date AS verapamil_start_date,
        medication_end_date AS verapamil_end_date,
        medication_name AS verapamil_name,
        medication_code AS verapamil_code
    FROM {gp_prescriptions}
    WHERE medication_code IN (SELECT code FROM verapamil_codes)
        AND medication_start_date IS NOT NULL
),

beta_blocker_prescriptions AS (
    SELECT DISTINCT
        FK_Patient_Link_ID,
        medication_start_date AS beta_blocker_start_date,
        medication_end_date AS beta_blocker_end_date,
        medication_name AS beta_blocker_name,
        medication_code AS beta_blocker_code
    FROM {gp_prescriptions}
    WHERE medication_code IN (SELECT code FROM beta_blocker_codes)
        AND medication_start_date IS NOT NULL
),

concurrent_contraindication AS (
    SELECT DISTINCT
        ver.FK_Patient_Link_ID,
        ver.verapamil_name,
        ver.verapamil_start_date,
        ver.verapamil_end_date,
        bb.beta_blocker_name,
        bb.beta_blocker_start_date,
        bb.beta_blocker_end_date,
        -- Calculate overlap period (when BOTH medications are active)
        GREATEST(ver.verapamil_start_date, bb.beta_blocker_start_date) as hazard_start_date,
        LEAST(
            COALESCE(ver.verapamil_end_date, ver.verapamil_start_date + INTERVAL '90 days'),
            COALESCE(bb.beta_blocker_end_date, bb.beta_blocker_start_date + INTERVAL '90 days')
        ) as hazard_end_date
    FROM verapamil_prescriptions ver
    INNER JOIN beta_blocker_prescriptions bb
        ON ver.FK_Patient_Link_ID = bb.FK_Patient_Link_ID
    WHERE
        -- Check for overlapping prescriptions
        ver.verapamil_start_date <= COALESCE(bb.beta_blocker_end_date, bb.beta_blocker_start_date + INTERVAL '90 days')
        AND COALESCE(ver.verapamil_end_date, ver.verapamil_start_date + INTERVAL '90 days') >= bb.beta_blocker_start_date
)

-- Return results
SELECT DISTINCT
    FK_Patient_Link_ID,
    '038' as filter_id,
    hazard_start_date as start_date,
    hazard_end_date as end_date
FROM concurrent_contraindication;
